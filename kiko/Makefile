##
##  Makefile -- Build procedure for sample kiko Apache module
##  Autogenerated via ``apxs -n kiko -g''.
##

#builddir=.
#top_srcdir=/usr/share/apache2
#top_builddir=/usr/share/apache2
#include /usr/share/apache2/build/special.mk

#   the used tools
#APACHECTL=apachectl

#   additional defines, includes and libraries
#DEFS=-Dmy_define=my_value
#INCLUDES=-Imy/include/dir
#LIBS=-Lmy/lib/dir -lmylib

#   the default target
#all: local-shared-build

#   install the shared object file into Apache 
#install: install-modules-yes

#   cleanup
#clean:
#	-rm -f mod_kiko.o mod_kiko.lo mod_kiko.slo mod_kiko.la 

#   simple test
#test: reload
#	lynx -mime_header http://localhost/kiko

#   install and activate shared object by reloading Apache to
#   force a reload of the shared object file
#reload: install restart

#   the general Apache start/restart/stop
#   procedures
#start:
#	$(APACHECTL) start
#restart:
#	$(APACHECTL) restart
#stop:
#	$(APACHECTL) stop

# Définition des variables
CC=g++
CFLAGS=-c -fPIC -I/usr/include/apache2/ -I/usr/include/apr-1.0/
LDFLAGS=-shared -fPIC
LDLIBS=-lapr-1 -laprutil-1
SOURCE=mod_kiko.cpp
OBJECT=$(SOURCE:.cpp=.o)
TARGET=/usr/lib/apache2/modules/mod_kiko.so
MODULE_NAME=mod_kiko.so
PREDICAT=predicat.cpp
PREDICATOBJECT=$(PREDICAT:.cpp=.o)

# Règle par défaut
all: build install restart_apache

# Compilation du fichier source
build: $(OBJECT)
$(OBJECT): $(SOURCE)
	$(CC) $(CFLAGS) $(SOURCE) -o $(OBJECT)

# Compilation du fichier source
build: $(PREDICATOBJECT)
$(PREDICATOBJECT): $(PREDICAT)
	$(CC) $(CFLAGS) $(PREDICAT) -o $(PREDICATOBJECT)

# Liaison du fichier objet en un module dynamique
$(MODULE_NAME): $(OBJECT)
	$(CC) $(LDFLAGS) -o $(MODULE_NAME) $(PREDICATOBJECT) $(OBJECT) $(LDLIBS)

# Installation du module dans le répertoire approprié
install: $(MODULE_NAME)
	sudo cp $(MODULE_NAME) $(TARGET)

# Redémarrage du service Apache
restart_apache:
	sudo service apache2 stop
	sudo service apache2 start

# Nettoyage des fichiers générés
clean:
	rm -f $(OBJECT) $(MODULE_NAME)

# Règles pour éviter des conflits entre des fichiers et des règles
.PHONY: all build install restart_apache clean
